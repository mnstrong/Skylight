<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Skylight</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:ital,wght@0,100..900;1,100..900&family=Noticia+Text:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="mobile.css">
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <div class="nav-sidebar">
            <a href="#/calendar" class="nav-item active">
                <div class="nav-icon icon-calendar"></div>
                <div>Calendar</div>
            </a>
            <a href="#/chores" class="nav-item">
                <div class="nav-icon icon-tasks"></div>
                <div>Chores</div>
            </a>
            <a href="#/rewards" class="nav-item">
                <div class="nav-icon icon-rewards"></div>
                <div>Rewards</div>
            </a>
            <a href="#/meals" class="nav-item">
                <div class="nav-icon icon-meals"></div>
                <div>Meals</div>
            </a>
            <a href="#/allowance" class="nav-item">
                <div class="nav-icon icon-allowance"></div>
                <div>Allowance</div>
            </a>
            <a href="#/recipes" class="nav-item">
                <div class="nav-icon icon-recipes"></div>
                <div>Recipes</div>
            </a>
            <a href="#/lists" class="nav-item">
                <div class="nav-icon icon-lists"></div>
                <div>Lists</div>
            </a>
            <a href="#/habits" class="nav-item">
                <div class="nav-icon" style="font-size: 28px;">üå±</div>
                <div>Habits</div>
            </a>
            <div style="flex: 1;"></div>
            <a href="#" class="nav-item" onclick="event.preventDefault();openProfilePicker()">
                <div class="nav-icon" style="font-size: 28px;">üë§</div>
                <div>Profile</div>
            </a>
            <a href="#/timer" class="nav-item">
                <div class="nav-icon" style="font-size: 28px;">‚è±Ô∏è</div>
                <div>Timer</div>
            </a>
        </div>

        <div class="header">
            <div class="header-left">
                <div class="date-time-group">
                    <div class="date-weather-line">
                        <span id="dateDisplay"></span>
                        <span class="time-line" id="timeDisplay"></span>
                        <span class="weather-inline" id="weatherDisplay">Loading...</span>                    </div>
                    </div>
            </div>
            <div class="header-right">
                <select class="view-selector" id="mainViewSelector" onchange="switchViewFromDropdown(this.value)">
                    <option value="month">Month</option>
                    <option value="week">Week</option>
                    <option value="schedule">Schedule</option>
                    <option value="day">Day</option>
                </select>
                <div class="calendar-filter-btn" id="calendarFilterBtn" onclick="toggleCalendarFilter()">
                    <span class="calendar-filter-icon">üîç</span>
                    <span>Filter</span>
                    <div class="calendar-filter-dropdown" id="calendarFilterDropdown" onclick="event.stopPropagation()">
                        <div class="calendar-filter-header">Filter Calendar</div>
                        <div id="calendarFilterList">
                            <!-- Filter items will be populated here -->
                        </div>
                        <div id="choresFilterSection" style="display: none;">
                            <div class="calendar-filter-divider"></div>
                            <label class="calendar-filter-item">
                                <input type="checkbox" id="showCompletedChores" onchange="toggleShowCompletedChores()">
                                <span>Show Completed</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="today-nav" id="todayNav">
                    <button class="today-nav-btn" onclick="navigateDay(-1)"><</button>
                    <button class="today-nav-btn today-text" onclick="goToToday()">Today</button>
                    <button class="today-nav-btn" onclick="navigateDay(1)">></button>
                </div>
                <div class="month-nav" id="monthNav">
                    <button class="month-nav-btn" onclick="navigateView(-1)"><</button>
                    <span class="month-display middle" id="monthDisplay"></span>
                    <button class="month-nav-btn" onclick="navigateView(1)">></button>
                </div>
                <div class="week-nav" id="weekNav">
                    <button class="week-nav-btn" onclick="navigateView(-1)"><</button>
                    <span class="week-display middle" id="weekDisplay"></span>
                    <button class="week-nav-btn" onclick="navigateView(1)">></button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="contentArea"></div>
        </div>

        <div class="sidebar" style="display: none;">
            <div class="section-title">Family Members</div>
            <div class="family-members" id="familyMembers"></div>
            <button class="add-btn" onclick="addFamilyMember()">+ Add Member</button>

            <div class="section-title" style="margin-top: 30px;">Quick Actions</div>
            <button class="add-btn" onclick="openEventModal()">+ Add Event</button>
            <button class="add-btn" onclick="openTaskModal()">+ Add Task</button>
        </div>

        <div class="main-calendar" style="display: none;">
            <div class="tabs">
                <button class="tab active" onclick="switchView('month')">Month</button>
                <button class="tab" onclick="switchView('week')">Week</button>
                <button class="tab" onclick="switchView('schedule')">Schedule</button>
                <button class="tab" onclick="switchView('day')">Day</button>
            </div>
            
            <div class="calendar-header">
                <button class="nav-btn" onclick="navigateView(-1)">‚Üê</button>
                <h2 id="monthYear"></h2>
                <button class="nav-btn" onclick="navigateView(1)">‚Üí</button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid"></div>
            
            <div class="week-view" id="weekView"></div>
            
            <div class="schedule-view" id="scheduleView">
                <div class="schedule-container" id="scheduleContainer"></div>
            </div>
            
            <div class="day-view" id="dayView"></div>
        </div>

        <div class="right-panel" style="display: none;">
            <div class="section-title">Today's Tasks</div>
            <ul class="task-list" id="taskList"></ul>

            <div class="section-title" style="margin-top: 30px;">This Week's Meals</div>
            <div class="meal-plan" id="mealPlan"></div>
            <button class="add-btn" onclick="openMealModal()">+ Add Meal</button>
        </div>
    </div>

    <button class="floating-add-btn" id="floatingAddBtn" onclick="openEventModalForCurrentDay()">+</button>
    
    <button class="floating-add-task-btn" id="floatingAddTaskBtn" onclick="handleFloatingAdd()">+</button>

    <!-- Add Task Side Panel (replaces centered modal) -->
    <div class="edit-panel-overlay" id="taskChorePanelOverlay" onclick="closeModal('taskChoreModal')"></div>
    <div class="edit-side-panel" id="taskChoreModal">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeModal('taskChoreModal')">‚Üê</button>
            <div class="edit-panel-title">Add task</div>
        </div>
        
        <div class="edit-panel-body">
            <!-- Title -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">‚ò∞</span>
                        <span>Title</span>
                    </div>
                </div>
                <input type="text" class="edit-form-input" id="taskChoreTitle" placeholder="Task title" style="margin-top: 10px;">
            </div>
            
            <!-- Emoji -->
            <div class="edit-form-group emoji-picker-container">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üòä</span>
                        <span>Emoji (optional)</span>
                    </div>
                </div>
                <div style="position: relative; margin-top: 10px;">
                    <input type="text" class="edit-form-input" id="taskChoreEmoji" placeholder="Select emoji" readonly style="color: transparent; text-shadow: 0 0 0 #000; cursor: pointer;" onclick="toggleTaskEmojiPicker(event)">
                    <span id="taskChoreEmojiDisplay" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none;"></span>
                </div>
                
                <div class="emoji-picker-dropdown" id="taskEmojiPickerDropdown">
                    <input type="text" class="emoji-search-input" id="taskEmojiSearchInput" placeholder="Search emojis..." onkeyup="filterTaskEmojis()" onclick="event.stopPropagation()">
                    <div class="emoji-picker-grid" id="taskEmojiPickerGrid"></div>
                </div>
            </div>
            
            <!-- Profiles -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üë•</span>
                        <span>Profiles</span>
                    </div>
                </div>
                <div class="edit-profile-grid" id="taskProfileGrid" style="margin-top: 10px;">
                    <!-- Profiles will be populated here -->
                </div>
            </div>
            
            <!-- Chore/Routine Toggle -->
            <div class="edit-form-group">
                <div style="display: flex;">
                    <button class="routine-choice-btn" id="choreTypeBtn" onclick="setTaskType('chore')">Chore</button>
                    <button class="routine-choice-btn active" id="routineTypeBtn" onclick="setTaskType('routine')">Routine</button>
                </div>
            </div>
            
            <!-- CHORE-SPECIFIC FIELDS -->
            <div id="choreFields" style="display: none;">
                <!-- Date -->
                <div class="edit-form-group">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">üìÖ</span>
                            <span>Date</span>
                        </div>
                        <label class="edit-toggle-switch">
                            <input type="checkbox" id="taskChoreDate" onchange="toggleChoreDate()">
                            <span class="edit-toggle-slider"></span>
                        </label>
                    </div>
                    <input type="date" class="edit-form-input" id="taskChoreDateValue" style="margin-top: 10px; display: none;">
                </div>
                
                <!-- Time -->
                <div class="edit-form-group">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">‚è∞</span>
                            <span>Time</span>
                        </div>
                        <label class="edit-toggle-switch">
                            <input type="checkbox" id="taskChoreTime" onchange="toggleChoreTime()">
                            <span class="edit-toggle-slider"></span>
                        </label>
                    </div>
                    <input type="time" class="edit-form-input" id="taskChoreTimeValue" style="margin-top: 10px; display: none;">
                </div>
                
                <!-- Repeats -->
                <div class="edit-form-group">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">üîÑ</span>
                            <span>Repeats</span>
                        </div>
                        <label class="edit-toggle-switch">
                            <input type="checkbox" id="taskChoreRepeatToggle" onchange="toggleChoreRepeat()">
                            <span class="edit-toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="taskChoreRepeatDetails" style="display: none;">
                    <!-- Repeat Frequency -->
                    <div class="edit-form-group">
                        <div class="edit-toggle-row" style="padding: 10px 0;">
                            <div class="edit-toggle-label">
                                <span class="edit-toggle-icon">üîÑ</span>
                                <span>Every</span>
                            </div>
                        </div>
                        <div style="display: flex; margin-top: 10px;">
                            <input type="number" class="routine-number-input" id="choreRepeatEvery" value="1" min="1">
                            <button class="routine-choice-btn active" id="choreRepeatDay" onclick="setChoreRepeatUnit('day')">Day</button>
                            <button class="routine-choice-btn" id="choreRepeatWeek" onclick="setChoreRepeatUnit('week')">Week</button>
                            <button class="routine-choice-btn" id="choreRepeatMonth" onclick="setChoreRepeatUnit('month')">Month</button>
                        </div>
                    </div>
                    
                    <!-- Days of Week (only shown when repeat unit is week) -->
                    <div class="edit-form-group" id="choreRepeatDays" style="display: none;">
                        <div class="edit-toggle-row" style="padding: 10px 0;">
                            <div class="edit-toggle-label">
                                <span class="edit-toggle-icon">üìÖ</span>
                                <span>On</span>
                            </div>
                        </div>
                        <div class="days-selector-new" style="margin-top: 10px;">
                            <button type="button" class="day-btn-new" data-day="0" onclick="toggleChoreDayNew(0)">Su</button>
                            <button type="button" class="day-btn-new" data-day="1" onclick="toggleChoreDayNew(1)">Mo</button>
                            <button type="button" class="day-btn-new" data-day="2" onclick="toggleChoreDayNew(2)">Tu</button>
                            <button type="button" class="day-btn-new" data-day="3" onclick="toggleChoreDayNew(3)">We</button>
                            <button type="button" class="day-btn-new" data-day="4" onclick="toggleChoreDayNew(4)">Th</button>
                            <button type="button" class="day-btn-new" data-day="5" onclick="toggleChoreDayNew(5)">Fr</button>
                            <button type="button" class="day-btn-new" data-day="6" onclick="toggleChoreDayNew(6)">Sa</button>
                        </div>
                    </div>
                    
                    <!-- Repeats Until -->
                    <div class="edit-form-group">
                        <div class="edit-toggle-row" style="padding: 10px 0;">
                            <div class="edit-toggle-label">
                                <span class="edit-toggle-icon">üõë</span>
                                <span>Repeats Until</span>
                            </div>
                            <label class="edit-toggle-switch">
                                <input type="checkbox" id="choreRepeatsUntil" onchange="toggleChoreRepeatsUntil()">
                                <span class="edit-toggle-slider"></span>
                            </label>
                        </div>
                        <input type="date" class="edit-form-input" id="choreRepeatsUntilDate" style="margin-top: 10px; display: none;">
                    </div>
                </div>
            </div>
            
            <!-- ROUTINE-SPECIFIC FIELDS -->
            <div id="routineFields">
                <!-- Every (Repeat frequency) -->
                <div class="edit-form-group">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">üîÑ</span>
                            <span>Every</span>
                        </div>
                    </div>
                    <div style="display: flex; margin-top: 10px;">
                        <input type="number" class="routine-number-input" id="taskRepeatEvery" value="1" min="1">
                        <button class="routine-choice-btn" id="repeatDay" onclick="setRepeatUnit('day')">Day</button>
                        <button class="routine-choice-btn active" id="repeatWeek" onclick="setRepeatUnit('week')">Week</button>
                    </div>
                </div>
                
                <!-- On (Days of week) -->
                <div class="edit-form-group" id="taskRepeatDays">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">üìÖ</span>
                            <span>On</span>
                        </div>
                    </div>
                    <div class="days-selector-new" style="margin-top: 10px;">
                        <button type="button" class="day-btn-new" data-day="0" onclick="toggleDayNew(0)">Su</button>
                        <button type="button" class="day-btn-new" data-day="1" onclick="toggleDayNew(1)">Mo</button>
                        <button type="button" class="day-btn-new" data-day="2" onclick="toggleDayNew(2)">Tu</button>
                        <button type="button" class="day-btn-new" data-day="3" onclick="toggleDayNew(3)">We</button>
                        <button type="button" class="day-btn-new active" data-day="4" onclick="toggleDayNew(4)">Th</button>
                        <button type="button" class="day-btn-new" data-day="5" onclick="toggleDayNew(5)">Fr</button>
                        <button type="button" class="day-btn-new" data-day="6" onclick="toggleDayNew(6)">Sa</button>
                    </div>
                </div>
                
                <!-- In the (Time of day) -->
                <div class="edit-form-group">
                    <div class="edit-toggle-row" style="padding: 10px 0;">
                        <div class="edit-toggle-label">
                            <span class="edit-toggle-icon">‚òÄÔ∏è</span>
                            <span>In the</span>
                        </div>
                    </div>
                    <div style="display: flex; margin-top: 10px;">
                        <button class="routine-choice-btn" id="timeOfDayMorning" onclick="setTimeOfDay('morning')">Morning</button>
                        <button class="routine-choice-btn" id="timeOfDayAfternoon" onclick="setTimeOfDay('afternoon')">Afternoon</button>
                        <button class="routine-choice-btn active" id="timeOfDayEvening" onclick="setTimeOfDay('evening')">Evening</button>
                    </div>
                </div>
            </div>
            
            <!-- Stars (for both chores and routines) -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">‚≠ê</span>
                        <span>Stars</span>
                    </div>
                </div>
                <input type="number" class="edit-form-input" id="taskStars" placeholder="0" min="0" style="margin-top: 10px;">
            </div>
            
            <button class="edit-save-btn" onclick="saveTaskChore()">Add</button>
        </div>
    </div>

    <!-- Add Event Side Panel -->
    <div class="edit-panel-overlay" id="eventPanelOverlay" onclick="closeModal('eventModal')"></div>
    <div class="edit-side-panel" id="eventModal">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeModal('eventModal')">‚Üê</button>
            <div class="edit-panel-title">Add Event</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Title</label>
                <input type="text" class="edit-form-input" id="eventTitle" placeholder="Event title">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Start Date</label>
                <input type="date" class="edit-form-input" id="eventDate">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">End Date (Optional)</label>
                <input type="date" class="edit-form-input" id="eventEndDate">
            </div>
            
            <div class="edit-form-group">
                <div class="edit-toggle-row">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üïê</span>
                        <span>All-Day Event</span>
                    </div>
                    <label class="task-toggle">
                        <input type="checkbox" id="eventAllDayToggle" checked onchange="updateEventTimeVisibility()">
                        <span class="task-toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div id="eventTimeSection" style="display: none;">
                <div class="edit-form-group">
                    <label class="edit-form-label">Start Time</label>
                    <input type="time" class="edit-form-input" id="eventTime">
                </div>
                
                <div class="edit-form-group">
                    <label class="edit-form-label">End Time</label>
                    <input type="time" class="edit-form-input" id="eventEndTime">
                </div>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Assigned To</label>
                <div id="eventProfileSummary" style="color: #999; font-size: 14px; margin-bottom: 8px; min-height: 20px;"></div>
                <div class="edit-profile-grid" id="eventProfileGrid">
                    <!-- Profiles will be populated here -->
                </div>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Notes (Optional)</label>
                <textarea class="edit-form-input" id="eventNotes" placeholder="Add notes..." rows="4" style="resize: vertical;"></textarea>
            </div>
            
            <div class="edit-form-group">
                <div class="edit-toggle-row">
                    <div class="edit-toggle-label">
                        <span>Repeats</span>
                    </div>
                    <label class="task-toggle">
                        <input type="checkbox" id="eventRepeatToggle" onchange="toggleRepeatSection()">
                        <span class="task-toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div id="repeatOptionsSection" style="display: none;">
                <div class="edit-form-group">
                    <label class="edit-form-label">Repeat Frequency</label>
                    <div class="edit-profile-grid">
                        <div class="edit-profile-item" data-repeat="daily" onclick="selectRepeatFrequency('daily')">
                            <div class="edit-profile-avatar" style="background: #667eea;">D</div>
                            <div class="edit-profile-name">Daily</div>
                        </div>
                        <div class="edit-profile-item" data-repeat="weekly" onclick="selectRepeatFrequency('weekly')">
                            <div class="edit-profile-avatar" style="background: #667eea;">W</div>
                            <div class="edit-profile-name">Weekly</div>
                        </div>
                        <div class="edit-profile-item" data-repeat="monthly" onclick="selectRepeatFrequency('monthly')">
                            <div class="edit-profile-avatar" style="background: #667eea;">M</div>
                            <div class="edit-profile-name">Monthly</div>
                        </div>
                        <div class="edit-profile-item" data-repeat="yearly" onclick="selectRepeatFrequency('yearly')">
                            <div class="edit-profile-avatar" style="background: #667eea;">Y</div>
                            <div class="edit-profile-name">Yearly</div>
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-group">
                    <div class="edit-toggle-row">
                        <div class="edit-toggle-label">
                            <span>Repeats until</span>
                        </div>
                        <label class="task-toggle">
                            <input type="checkbox" id="eventRepeatUntilToggle" onchange="toggleRepeatUntilSection()">
                            <span class="task-toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div id="repeatUntilSection" style="display: none;">
                    <div class="edit-form-group">
                        <label class="edit-form-label">End Type</label>
                        <div class="edit-profile-grid">
                            <div class="edit-profile-item" data-endtype="on" onclick="selectRepeatEndType('on')">
                                <div class="edit-profile-avatar" style="background: #667eea;">üìÖ</div>
                                <div class="edit-profile-name">On Date</div>
                            </div>
                            <div class="edit-profile-item" data-endtype="after" onclick="selectRepeatEndType('after')">
                                <div class="edit-profile-avatar" style="background: #667eea;">#</div>
                                <div class="edit-profile-name">After Count</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="edit-form-group" id="repeatEndDateGroup" style="display: none;">
                        <label class="edit-form-label">End Date</label>
                        <input type="date" class="edit-form-input" id="repeatEndDate">
                    </div>
                    
                    <div class="edit-form-group" id="repeatCountGroup" style="display: none;">
                        <label class="edit-form-label">Number of Occurrences</label>
                        <input type="number" class="edit-form-input" id="repeatCount" min="1" value="10">
                    </div>
                </div>
            </div>
            
            <button class="edit-save-btn" onclick="saveEvent()">Add Event</button>
        </div>
    </div>

    <div class="modal" id="taskModal" onclick="handleModalBackdropClick(event, 'taskModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Task</h2>
            <input type="text" id="taskTitle" placeholder="Task Title">
            <input type="date" id="taskDate">
            <select id="taskMember">
                <option value="">Select Family Member</option>
            </select>
            <button class="add-btn" onclick="saveTask()">Save Task</button>
            <button class="close-btn" onclick="closeModal('taskModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="mealModal" onclick="handleModalBackdropClick(event, 'mealModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Meal</h2>
            <input type="date" id="mealDate">
            <input type="text" id="mealName" placeholder="Meal Name">
            <button class="add-btn" onclick="saveMeal()">Save Meal</button>
            <button class="close-btn" onclick="closeModal('mealModal')">Cancel</button>
        </div>
    </div>

    <div class="modal" id="rewardModal" onclick="handleModalBackdropClick(event, 'rewardModal')">
        <div class="modal-content task-modal" onclick="event.stopPropagation()">
            <div class="task-modal-header">
                <button class="task-modal-back" onclick="closeModal('rewardModal')">‚Üê</button>
                <h2>Add Reward</h2>
            </div>
            
            <div class="task-modal-body">
                <div class="task-form-group">
                    <label class="task-form-icon">‚â°</label>
                    <input type="text" id="rewardTitle" placeholder="Reward Title" class="task-input">
                </div>
                
                <div class="task-form-group emoji-picker-container">
                    <label class="task-form-icon">üòä</label>
                    <div style="position: relative; flex: 1;">
                        <input type="text" id="rewardEmoji" placeholder="Emoji" class="task-input" readonly style="color: transparent; text-shadow: 0 0 0 #000;">
                        <span id="rewardEmojiDisplay" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none;"></span>
                    </div>
                    <button class="task-dropdown-btn" onclick="toggleRewardEmojiPicker(event)">‚ñº</button>
                    
                    <div class="emoji-picker-dropdown" id="rewardEmojiPickerDropdown">
                        <input type="text" class="emoji-search-input" id="rewardEmojiSearchInput" placeholder="Search emojis..." onkeyup="filterRewardEmojis()" onclick="event.stopPropagation()">
                        <div class="emoji-picker-grid" id="rewardEmojiPickerGrid"></div>
                    </div>
                </div>
                
                <div class="task-form-group">
                    <label class="task-form-icon">üë•</label>
                    <div class="task-form-label">Profile</div>
                </div>
                
                <div class="task-profile-grid" id="rewardProfileGrid"></div>
                
                <div class="task-form-group">
                    <label class="task-form-icon">‚≠ê</label>
                    <div class="task-form-label">Stars Required</div>
                    <input type="number" id="rewardStars" value="25" min="1" class="task-input-small" style="width: 80px;">
                </div>
                
                <button class="task-submit-btn" onclick="saveReward()">Add Reward</button>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal -->
    <div class="task-detail-modal" id="taskDetailModal" onclick="handleModalBackdropClick(event, 'taskDetailModal')">
        <div class="task-detail-content" onclick="event.stopPropagation()">
            <div class="task-detail-title" id="detailTaskTitle">Task Title</div>
            
            <div class="task-detail-actions">
                <button class="task-detail-btn task-detail-edit" onclick="openEditPanelFromDetail()">
                    ‚úèÔ∏è Edit
                </button>
                <button class="task-detail-btn task-detail-delete" onclick="deleteCurrentTask()">
                    üóëÔ∏è Delete
                </button>
            </div>
            
            <div class="task-detail-info">
                <div class="task-detail-row" id="detailTaskDate">
                    <div class="task-detail-icon">üìÖ</div>
                    <span id="detailDateText">Tuesday, April 1, 8:00 PM</span>
                </div>
                
                <div class="task-detail-row" id="detailTaskRepeat" style="display: none;">
                    <div class="task-detail-icon">üîÑ</div>
                    <span id="detailRepeatText">Weekly on Tue</span>
                </div>
                
                <div class="task-detail-row">
                    <div class="task-detail-icon">üë•</div>
                    <div class="task-detail-label">Assigned To</div>
                </div>
                
                <div class="task-detail-assigned" id="detailAssignedTo">
                    <!-- Assigned members will be populated here -->
                </div>
            </div>
            
            <button class="task-detail-complete-btn" id="detailCompleteBtn" onclick="toggleCurrentTask()">
                Mark as Complete
            </button>
        </div>
    </div>
    
    <!-- Edit Side Panel -->
    <div class="edit-panel-overlay" id="editPanelOverlay" onclick="closeEditPanel()"></div>
    <div class="edit-side-panel" id="editSidePanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeEditPanel()">‚Üê</button>
            <div class="edit-panel-title">Edit Task</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Title</label>
                <input type="text" class="edit-form-input" id="editTaskTitle" placeholder="Task title">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Emoji (Optional)</label>
                <div style="display: flex; align-items: center;">
                    <input type="text" class="edit-form-input" id="editTaskEmoji" placeholder="üòä" readonly style="flex: 1;">
                    <button class="task-dropdown-btn" onclick="toggleEditEmojiPicker(event)" style="padding: 15px; font-size: 18px;">‚ñº</button>
                </div>
                <div class="emoji-picker-dropdown" id="editEmojiPickerDropdown" style="position: relative; margin-top: 10px;">
                    <input type="text" class="emoji-search-input" id="editEmojiSearchInput" placeholder="Search emojis..." onkeyup="filterEditEmojis()" onclick="event.stopPropagation()">
                    <div class="emoji-picker-grid" id="editEmojiPickerGrid"></div>
                </div>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Profiles</label>
                <div class="edit-profile-grid" id="editProfileGrid">
                    <!-- Profiles will be populated here -->
                </div>
            </div>
            
            <div class="edit-form-group">
                <div class="edit-type-toggle">
                    <button class="edit-type-btn active" id="editChoreTypeBtn" onclick="setEditTaskType('chore')">Chore</button>
                    <button class="edit-type-btn" id="editRoutineTypeBtn" onclick="setEditTaskType('routine')">Routine</button>
                </div>
            </div>
            
            <div class="edit-form-group">
                <div class="edit-toggle-row">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üìÖ</span>
                        <span>Date</span>
                    </div>
                    <label class="task-toggle">
                        <input type="checkbox" id="editTaskDateToggle" checked onchange="updateEditDateVisibility()">
                        <span class="task-toggle-slider"></span>
                    </label>
                </div>
                <input type="date" class="edit-form-input" id="editTaskDate" style="margin-top: 10px;">
            </div>
            
            <div class="edit-form-group">
                <div class="edit-toggle-row">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üïê</span>
                        <span>Time</span>
                    </div>
                    <label class="task-toggle">
                        <input type="checkbox" id="editTaskTimeToggle" onchange="updateEditTimeVisibility()">
                        <span class="task-toggle-slider"></span>
                    </label>
                </div>
                <input type="time" class="edit-form-input" id="editTaskTime" style="margin-top: 10px; display: none;">
            </div>
            
            <div class="edit-form-group" id="editStarsSection">
                <label class="edit-form-label">Stars</label>
                <input type="number" class="edit-form-input" id="editTaskStars" value="5" min="0">
            </div>
            
            <button class="edit-save-btn" onclick="saveEditedTask()">Save</button>
            <button class="edit-delete-btn" onclick="deleteCurrentTask()">
                <span>üóëÔ∏è</span>
                <span>Delete Task</span>
            </button>
        </div>
    </div>
    
    <!-- Meal Selector Side Panel -->
    <div class="edit-panel-overlay" id="mealSelectorOverlay" onclick="closeMealSelector()"></div>
    <div class="edit-side-panel" id="mealSelectorPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeMealSelector()">‚Üê</button>
            <div class="edit-panel-title" id="mealSelectorTitle">Select Meal</div>
        </div>
        
        <div id="mealSelectorList" class="edit-panel-body" style="padding: 0;">
            <!-- Recipe list will be populated here -->
        </div>
    </div>
    
    <!-- Add Recipe Side Panel -->
    <div class="edit-panel-overlay" id="addRecipePanelOverlay" onclick="closeAddRecipePanel()"></div>
    <div class="edit-side-panel" id="addRecipePanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeAddRecipePanel()">‚Üê</button>
            <div class="edit-panel-title">Add Recipe</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Import from URL (Optional)</label>
                <div style="display: flex;">
                    <input type="url" class="edit-form-input" id="addRecipeURL" placeholder="Paste recipe URL..." style="flex: 1;">
                    <button class="task-dropdown-btn" onclick="importRecipeFromURL()" style="padding: 15px; background: #4A90E2; color: white; border-radius: 8px; font-weight: 600;">Import</button>
                </div>
                <div id="importStatus" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
            </div>
            
            <div style="text-align: center; margin: 15px 0; color: #999; font-size: 14px;">‚Äî OR ‚Äî</div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Recipe Name</label>
                <input type="text" class="edit-form-input" id="addRecipeName" placeholder="Enter recipe name">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Meal Type</label>
                <select class="edit-form-input" id="addRecipeMealType">
                    <option value="Breakfast">Breakfast</option>
                    <option value="Lunch">Lunch</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snack">Snack</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Ingredients</label>
                <textarea class="edit-form-input" id="addRecipeIngredients" rows="4" placeholder="List ingredients..."></textarea>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Instructions</label>
                <textarea class="edit-form-input" id="addRecipeInstructions" rows="4" placeholder="Cooking instructions..."></textarea>
            </div>
            
            <button class="edit-save-btn" onclick="saveNewRecipe()">Save Recipe</button>
        </div>
    </div>
    
    <!-- Add List Side Panel -->
    <div class="edit-panel-overlay" id="addListPanelOverlay" onclick="closeAddListPanel()"></div>
    <div class="edit-side-panel" id="addListPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeAddListPanel()">‚Üê</button>
            <div class="edit-panel-title">Add List</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">List Name</label>
                <input type="text" class="edit-form-input" id="addListName" placeholder="Enter list name">
            </div>
            
            <div class="task-form-group">
                <label class="task-form-icon">üë•</label>
                <div class="task-form-label">Assigned To</div>
            </div>
            
            <div class="task-profile-grid" id="addListProfileGrid"></div>
            
            <button class="edit-save-btn" onclick="saveNewList()">Create List</button>
        </div>
    </div>
    
    <!-- Add List Item Side Panel -->
    <div class="edit-panel-overlay" id="addListItemPanelOverlay" onclick="closeAddListItemPanel()"></div>
    <div class="edit-side-panel" id="addListItemPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeAddListItemPanel()">‚Üê</button>
            <div class="edit-panel-title">Add Item</div>
        </div>
        
        <div class="edit-panel-body">
            <!-- Title -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">‚ò∞</span>
                        <span>Title</span>
                    </div>
                </div>
                <input type="text" class="edit-form-input" id="listItemTitle" placeholder="Item name" style="margin-top: 10px;">
            </div>
            
            <!-- Emoji -->
            <div class="edit-form-group emoji-picker-container">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üòä</span>
                        <span>Emoji (optional)</span>
                    </div>
                </div>
                <div style="position: relative; margin-top: 10px;">
                    <input type="text" class="edit-form-input" id="listItemEmoji" placeholder="Select emoji" readonly style="color: transparent; text-shadow: 0 0 0 #000; cursor: pointer;" onclick="toggleListItemEmojiPicker(event)">
                    <span id="listItemEmojiDisplay" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; pointer-events: none;"></span>
                </div>
                
                <div class="emoji-picker-dropdown" id="listItemEmojiPickerDropdown">
                    <input type="text" class="emoji-search-input" id="listItemEmojiSearchInput" placeholder="Search emojis..." onkeyup="filterListItemEmojis()" onclick="event.stopPropagation()">
                    <div class="emoji-picker-grid" id="listItemEmojiPickerGrid"></div>
                </div>
            </div>
            
            <!-- List Selection -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üìã</span>
                        <span>List</span>
                    </div>
                </div>
                <select class="edit-form-input" id="listItemListSelect" style="margin-top: 10px;">
                    <option value="">Select a list...</option>
                </select>
            </div>
            
            <!-- Profile Assignment -->
            <div class="edit-form-group">
                <div class="edit-toggle-row" style="padding: 10px 0;">
                    <div class="edit-toggle-label">
                        <span class="edit-toggle-icon">üë§</span>
                        <span>Assigned To (optional)</span>
                    </div>
                </div>
                <div class="edit-profile-grid" id="listItemProfileGrid" style="margin-top: 10px;">
                    <!-- Profiles will be populated here -->
                </div>
            </div>
            
            <button class="edit-save-btn" onclick="saveNewListItem()">Add Item</button>
        </div>
    </div>
    
    <!-- Add Section Modal -->
    <div class="modal" id="addSectionModal" onclick="handleModalBackdropClick(event, 'addSectionModal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>Add Section</h2>
            <input type="text" id="sectionNameInput" placeholder="Section name" onkeypress="if(event.key==='Enter') saveNewSection()">
            <input type="hidden" id="sectionListId">
            <button class="add-btn" onclick="saveNewSection()">Add Section</button>
            <button class="close-btn" onclick="closeModal('addSectionModal')">Cancel</button>
        </div>
    </div>
    
    <!-- Meal Detail Modal -->
    <div class="meal-detail-modal" id="mealDetailModal" onclick="if(event.target === this) closeMealDetail()">
        <div class="meal-detail-content" onclick="event.stopPropagation()">
            <div class="meal-detail-header">
                <div class="meal-detail-title" id="mealDetailTitle">Recipe Name</div>
                <div class="meal-detail-actions">
                    <button class="meal-detail-btn meal-detail-edit" onclick="editMealFromDetail()">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="meal-detail-btn meal-detail-delete" onclick="deleteMealFromDetail()">
                        üóëÔ∏è Delete
                    </button>
                </div>
            </div>
            
            <div class="meal-detail-info">
                <div class="meal-detail-info-row">
                    üìÖ <span id="mealDetailDate">Date</span>
                </div>
                <div class="meal-detail-info-row">
                    <span id="mealDetailCategoryDot" style="width: 12px; height: 12px; border-radius: 50%; background: #999; display: inline-block;"></span>
                    <span id="mealDetailCategory">Category</span>
                </div>
            </div>
            
            <div class="meal-detail-section">
                <div class="meal-detail-section-title">INGREDIENTS:</div>
                <div class="meal-detail-text" id="mealDetailIngredients">Ingredients will appear here</div>
            </div>
            
            <div class="meal-detail-section">
                <div class="meal-detail-section-title">INSTRUCTIONS:</div>
                <div class="meal-detail-text" id="mealDetailInstructions">Instructions will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- List Item Detail Modal -->
    <div class="task-detail-modal" id="listItemDetailModal" onclick="if(event.target === this) closeListItemDetail()">
        <div class="task-detail-content" onclick="event.stopPropagation()">
            <div class="task-detail-title" id="listItemDetailTitle">Item</div>
            
            <div class="task-detail-actions">
                <button class="task-detail-btn task-detail-edit" onclick="editListItemFromDetail()">
                    ‚úèÔ∏è Edit
                </button>
                <button class="task-detail-btn task-detail-delete" onclick="deleteListItemFromDetail()">
                    üóëÔ∏è Delete
                </button>
            </div>
            
            <div class="task-detail-info">
                <div class="task-detail-row">
                    <div class="task-detail-icon">üìã</div>
                    <div class="task-detail-label">List:</div>
                    <span id="listItemDetailListName">List Name</span>
                </div>
                
                <div class="task-detail-row">
                    <div class="task-detail-icon">üë•</div>
                    <div class="task-detail-label">Assigned To:</div>
                    <div class="task-detail-assigned" id="listItemDetailAssignedTo">
                        <!-- Assigned member will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Detail Side Panel -->
    <div class="edit-panel-overlay" id="eventDetailPanelOverlay" onclick="closeEventDetailPanel()"></div>
    <div class="edit-side-panel" id="eventDetailPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeEventDetailPanel()">‚Üê</button>
            <div class="edit-panel-title">Event Details</div>
        </div>
        
        <div class="edit-panel-body">
            <div style="margin-bottom: 30px;">
                <div style="font-size: 24px; font-weight: 600; color: #000; margin-bottom: 20px;" id="eventDetailTitle">Event Title</div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;">
                    <div class="task-detail-icon">üìÖ</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Date & Time</div>
                        <div style="color: #000; font-size: 16px; font-weight: 500;" id="eventDetailDateTime">Monday, January 20, 2026 at 3:00 PM</div>
                    </div>
                </div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;" id="eventDetailReminderRow">
                    <div class="task-detail-icon">üîî</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Reminder</div>
                        <div style="color: #000; font-size: 16px; font-weight: 500;" id="eventDetailReminder">15 minutes before</div>
                    </div>
                </div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;" id="eventDetailMemberRow">
                    <div class="task-detail-icon">üë§</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Assigned To</div>
                        <div class="task-detail-assigned" id="eventDetailMember">
                            <!-- Member will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;" id="eventDetailCalendarRow">
                    <div class="task-detail-icon">üìÜ</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Calendar</div>
                        <div style="color: #000; font-size: 16px; font-weight: 500;" id="eventDetailCalendar">Google Calendar</div>
                    </div>
                </div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;" id="eventDetailInviteesRow">
                    <div class="task-detail-icon">üë•</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Invitees</div>
                        <div style="color: #000; font-size: 16px; font-weight: 500;" id="eventDetailInvitees">None</div>
                    </div>
                </div>
                
                <div class="task-detail-row" style="margin-bottom: 15px;" id="eventDetailNotesRow">
                    <div class="task-detail-icon">üìù</div>
                    <div style="flex: 1;">
                        <div style="color: #666; font-size: 14px;">Notes</div>
                        <div style="color: #666; font-size: 15px; line-height: 1.5; margin-top: 5px;" id="eventDetailNotes">No notes</div>
                    </div>
                </div>
            </div>
            
            <button class="edit-save-btn" onclick="editEventFromDetail()" id="eventDetailEditBtn">Edit Event</button>
            <button class="edit-delete-btn" onclick="deleteEventFromDetail()" id="eventDetailDeleteBtn">
                <span>üóëÔ∏è</span>
                <span>Delete Event</span>
            </button>
        </div>
    </div>
    
    <!-- Edit List Side Panel -->
    <div class="edit-panel-overlay" id="editListPanelOverlay" onclick="closeEditListPanel()"></div>
    <div class="edit-side-panel" id="editListPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeEditListPanel()">‚Üê</button>
            <div class="edit-panel-title">Edit List</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">List Name</label>
                <input type="text" class="edit-form-input" id="editListName" placeholder="List name">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Assigned To</label>
                <select class="edit-form-input" id="editListAssignedTo">
                </select>
            </div>
            
            <button class="edit-save-btn" onclick="saveEditedList()">Save</button>
            <button class="edit-delete-btn" onclick="deleteList()">Delete List</button>
        </div>
    </div>
    
    <!-- Edit List Item Side Panel -->
    <div class="edit-panel-overlay" id="editListItemPanelOverlay" onclick="closeEditListItemPanel()"></div>
    <div class="edit-side-panel" id="editListItemPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeEditListItemPanel()">‚Üê</button>
            <div class="edit-panel-title">Edit Item</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Item Text</label>
                <input type="text" class="edit-form-input" id="editListItemText" placeholder="Item text">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Assign To (Optional)</label>
                <div id="editListItemMemberGrid" class="task-profile-grid"></div>
            </div>
            
            <button class="edit-save-btn" onclick="saveEditedListItem()">Save</button>
        </div>
    </div>
    
    <!-- Edit Reward Side Panel -->
    <div class="edit-panel-overlay" id="editRewardPanelOverlay" onclick="closeEditRewardPanel()"></div>
    <div class="edit-side-panel" id="editRewardPanel">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeEditRewardPanel()">‚Üê</button>
            <div class="edit-panel-title">Edit Reward</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Title</label>
                <input type="text" class="edit-form-input" id="editRewardTitle" placeholder="Reward title">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Emoji (Optional)</label>
                <div style="display: flex; align-items: center;">
                    <input type="text" class="edit-form-input" id="editRewardEmoji" placeholder="üéÅ" readonly style="flex: 1;">
                    <button class="task-dropdown-btn" onclick="toggleEditRewardEmojiPicker(event)" style="padding: 15px; font-size: 18px;">‚ñº</button>
                </div>
                <div class="emoji-picker-dropdown" id="editRewardEmojiPickerDropdown" style="position: relative; margin-top: 10px;">
                    <input type="text" class="emoji-search-input" id="editRewardEmojiSearchInput" placeholder="Search emojis..." onkeyup="filterEditRewardEmojis()" onclick="event.stopPropagation()">
                    <div class="emoji-picker-grid" id="editRewardEmojiPickerGrid"></div>
                </div>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Stars Required</label>
                <input type="number" class="edit-form-input" id="editRewardStars" value="25" min="1">
            </div>
            
            <button class="edit-save-btn" onclick="saveEditedReward()">Save</button>
            <button class="edit-delete-btn" onclick="deleteCurrentReward()">
                <span>üóëÔ∏è</span>
                <span>Delete Reward</span>
            </button>
        </div>
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="task-detail-modal" id="editProfileModal" onclick="if(event.target === this) closeEditProfileModal()">
        <div class="task-detail-content" onclick="event.stopPropagation()">
            <div class="task-detail-title">Edit Profile</div>
            
            <div class="edit-form-group" style="margin-top: 30px;">
                <label class="edit-form-label">Name</label>
                <input type="text" class="edit-form-input" id="editProfileName" placeholder="Profile name">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Color</label>
                <div class="color-picker-container">
                    <button class="color-picker-nav" onclick="scrollColorPicker(-1)">‚Äπ</button>
                    <div class="color-picker-scroll" id="colorPickerScroll">
                        <div class="color-picker-grid" id="colorPickerGrid">
                            <!-- Colors will be populated here -->
                        </div>
                    </div>
                    <button class="color-picker-nav" onclick="scrollColorPicker(1)">‚Ä∫</button>
                </div>
            </div>
            
            <button class="edit-save-btn" onclick="saveEditedProfile()">Save Changes</button>
            <button class="task-detail-btn" style="width: 100%; margin-top: 10px; background: #f0f0f0; color: #666;" onclick="closeEditProfileModal()">Cancel</button>
        </div>
    </div>
    
    <!-- Reward Redemption Modal -->
    <div class="reward-redemption-modal" id="rewardRedemptionModal">
        <div class="reward-redemption-overlay"></div>
        <div class="reward-redemption-content">
            <div class="reward-redemption-emoji" id="redemptionEmoji">üéÅ</div>
            <div class="reward-redemption-title" id="redemptionTitle">Great work! Trip to the aquarium! redeemed</div>
            <div class="reward-redemption-subtitle" id="redemptionSubtitle">By Willow for 50 stars on April 02, 2025.</div>
            <button class="reward-redemption-done-btn" onclick="closeRewardRedemptionModal()">Done</button>
            <div class="reward-redemption-unredeem" onclick="unredeemCurrentReward()">Unredeem</div>
        </div>
    </div>
    <!-- Google Calendar OAuth uses redirect flow, no GIS library needed -->
    
    <!-- Clock Picker Modal -->
    <div class="clock-picker-modal" id="clockPickerModal" onclick="if(event.target === this) closeClockPicker()">
        <div class="clock-picker-content" onclick="event.stopPropagation()">
            <div class="clock-picker-header">
                <div class="clock-picker-time-display" id="clockTimeDisplay">12:00</div>
                <div class="clock-picker-period-toggle">
                    <button class="clock-period-btn active" id="clockAM" onclick="setClockPeriod('AM')">AM</button>
                    <button class="clock-period-btn" id="clockPM" onclick="setClockPeriod('PM')">PM</button>
                </div>
            </div>
            
            <div class="clock-picker-face" id="clockFace">
                <div class="clock-center-dot"></div>
                <div class="clock-hand" id="clockHand"></div>
                <!-- Numbers will be populated by JavaScript -->
            </div>
            
            <div class="clock-picker-actions">
                <button class="clock-picker-btn clock-picker-cancel" onclick="closeClockPicker()">Cancel</button>
                <button class="clock-picker-btn clock-picker-confirm" onclick="confirmClockTime()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Day Events Modal -->
    <div class="day-events-modal" id="dayEventsModal" onclick="if(event.target === this) closeDayEventsModal()">
        <div class="day-events-content" onclick="event.stopPropagation()">
            <div class="day-events-header">
                <div class="day-events-date" id="dayEventsDate">March 31</div>
                <div class="day-events-count" id="dayEventsCount">1 event</div>
            </div>
            
            <div class="day-events-list" id="dayEventsList">
                <!-- Events will be populated by JavaScript -->
            </div>
            
            <div class="day-events-footer">
                <button class="day-events-btn day-events-close" onclick="closeDayEventsModal()">Close</button>
                <button class="day-events-btn day-events-add" onclick="addEventFromDayModal()">+ Add Event</button>
            </div>
        </div>
    </div>
    
    <!-- Meal Filter Modal -->
    <div class="meal-filter-overlay" id="mealFilterOverlay" onclick="closeMealFilterModal()"></div>
    <div class="meal-filter-modal" id="mealFilterModal">
        <div class="meal-filter-header">
            <div class="meal-filter-title">Meal Categories</div>
            <button class="meal-filter-close" onclick="closeMealFilterModal()">‚úï</button>
        </div>
        
        <div class="meal-filter-body" id="mealFilterBody">
            <!-- Categories will be rendered here -->
        </div>
    </div>

    <!-- Edit Meal Category Modal -->
    <div class="edit-category-overlay" id="editCategoryOverlay" onclick="closeEditMealCategory()"></div>
    <div class="edit-category-modal" id="editCategoryModal">
        <div class="edit-category-header">
            <button class="edit-panel-back" onclick="closeEditMealCategory()">‚Üê</button>
            <div class="edit-panel-title">Edit Category</div>
        </div>
        
        <div class="edit-category-body">
            <input type="hidden" id="editCategoryIndex">
            
            <div class="edit-form-group">
                <label class="edit-form-label">Title</label>
                <input type="text" class="edit-form-input" id="editCategoryName" placeholder="Category name">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Color</label>
                <input type="hidden" id="editCategoryColor">
                <div class="color-picker-grid" id="editCategoryColorGrid"></div>
            </div>
            
            <button class="edit-save-btn" onclick="saveEditMealCategory()">Save</button>
        </div>
    </div>

    <!-- Delete Options Modal -->
    <div class="delete-options-overlay" id="deleteOptionsOverlay" onclick="closeDeleteOptions()"></div>
    <div class="delete-options-modal" id="deleteOptionsModal">
        <div class="delete-options-title">Delete Task</div>
        <div class="delete-options-message" id="deleteOptionsMessage">Choose what to delete:</div>
        
        <div class="delete-options-buttons">
            <button class="delete-option-btn" id="deleteCurrentBtn" onclick="confirmDelete('current')">
                Delete this task only
            </button>
            <button class="delete-option-btn" id="deleteFutureBtn" onclick="confirmDelete('future')">
                Delete all future tasks
            </button>
            <button class="delete-option-btn" id="deleteAllBtn" onclick="confirmDelete('all')">
                Delete all tasks
            </button>
            <button class="delete-cancel-btn" onclick="closeDeleteOptions()">
                Cancel
            </button>
        </div>
    </div>

    <!-- Allowance Modal -->
    <div class="edit-panel-overlay" id="allowancePanelOverlay" onclick="closeAllowanceModal()"></div>
    <div class="edit-side-panel" id="allowanceModal">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeAllowanceModal()">‚Üê</button>
            <div class="edit-panel-title">Add Transaction</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Type</label>
                <div class="allowance-type-toggle">
                    <button class="allowance-type-btn active" id="saveTypeBtn" onclick="setTransactionType('save')">Save</button>
                    <button class="allowance-type-btn" id="spendTypeBtn" onclick="setTransactionType('spend')">Spend</button>
                </div>
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Amount</label>
                <input type="number" class="edit-form-input" id="allowanceAmount" placeholder="5.00" step="0.01" min="0">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Description</label>
                <input type="text" class="edit-form-input" id="allowanceDescription" placeholder="What is this for?">
            </div>
            
            <button class="edit-save-btn" id="allowanceSaveBtn" onclick="saveAllowanceTransaction()">Save</button>
        </div>
    </div>
    
    <!-- Timer Set Modal -->
    <div class="edit-panel-overlay" id="timerSetPanelOverlay" onclick="closeTimerSetModal()"></div>
    <div class="edit-side-panel" id="timerSetModal">
        <div class="edit-panel-header">
            <button class="edit-panel-back" onclick="closeTimerSetModal()">‚Üê</button>
            <div class="edit-panel-title">Set Timer</div>
        </div>
        
        <div class="edit-panel-body">
            <div class="edit-form-group">
                <label class="edit-form-label">Hours</label>
                <input type="number" class="edit-form-input" id="timerSetHours" placeholder="0" min="0" max="23" value="0">
            </div>
            
            <div class="edit-form-group">
                <label class="edit-form-label">Minutes</label>
                <input type="number" class="edit-form-input" id="timerSetMinutes" placeholder="0" min="0" max="59" value="5">
            </div>
            
            <button class="edit-save-btn" onclick="saveTimerSet()">Set Timer</button>
        </div>
    </div>
<script src="supabase-config.js"></script>
<script src="supabase-sync.js"></script>
<script src="auto-sync-wrapper.js"></script>
<!-- Google Calendar OAuth Module -->
<script src="google-calendar-service-account.js"></script>
    <script src="script.js"></script>
<script src="supabase-init.js"></script>
<!-- =============================================
     MOBILE STRUCTURE
     Add to your index.html body
     ============================================= -->

<!-- Mobile Header (always visible on mobile) -->
<div class="mobile-header">
    <div class="mobile-header-left" id="mobileBackBtn" onclick="goToMobileHome()" style="display: none;">
        ‚Üê
    </div>
    <div class="mobile-header-left" id="mobileHomeIndicator" style="display: block;">
        <!-- Empty on home, back arrow on sections -->
    </div>
    <div class="mobile-header-title" id="mobileHeaderTitle">strongcalendar23</div>
    <div class="mobile-header-right" onclick="openProfileSettings()">
        üë§
    </div>
</div>

<!-- Mobile Calendar Navigation (shows only on calendar view) -->
<div class="mobile-calendar-nav" id="mobileCalendarNav">
    <div class="mobile-calendar-nav-row">
        <button class="mobile-calendar-nav-btn arrow" onclick="navigateView(-1)">
            <span>‚Üê</span>
        </button>
        <button class="mobile-calendar-nav-btn" onclick="goToToday()">
            <span>üìÖ</span>
            <span style="font-size: 11px;">Today</span>
        </button>
        <button class="mobile-calendar-nav-btn arrow" onclick="navigateView(1)">
            <span>‚Üí</span>
        </button>
        <button class="mobile-calendar-nav-btn" onclick="switchView('week')">
            <span>üìä</span>
            <span style="font-size: 11px;">Week</span>
        </button>
        <button class="mobile-calendar-nav-btn" onclick="toggleCalendarFilter()">
            <span>üîç</span>
            <span style="font-size: 11px;">Filter</span>
        </button>
        <button class="mobile-calendar-nav-btn" onclick="alert('Search coming soon!')">
            <span>üîé</span>
            <span style="font-size: 11px;">Search</span>
        </button>
    </div>
</div>

<!-- Mobile Home Page (Icon Grid Navigation) -->
<div class="mobile-home" id="mobileHome">
    
    <!-- Icon Navigation Grid -->
    <div class="mobile-icon-grid">
        
        <div class="mobile-icon-item" onclick="goToSection('calendar')">
            <div class="mobile-icon-circle mobile-icon-calendar">
                üìÖ
            </div>
            <div class="mobile-icon-label">Calendar</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('chores')">
            <div class="mobile-icon-circle mobile-icon-tasks">
                ‚úì
            </div>
            <div class="mobile-icon-label">Tasks</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('rewards')">
            <div class="mobile-icon-circle mobile-icon-rewards">
                ‚≠ê
                <div class="mobile-icon-badge">+</div>
            </div>
            <div class="mobile-icon-label">Rewards</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('lists')">
            <div class="mobile-icon-circle mobile-icon-lists">
                üìù
            </div>
            <div class="mobile-icon-label">Lists</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('meals')">
            <div class="mobile-icon-circle mobile-icon-meals">
                üç¥
                <div class="mobile-icon-badge">+</div>
            </div>
            <div class="mobile-icon-label">Meals</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('recipes')">
            <div class="mobile-icon-circle mobile-icon-recipes">
                üìñ
                <div class="mobile-icon-badge">+</div>
            </div>
            <div class="mobile-icon-label">Recipes</div>
        </div>
        
        <div class="mobile-icon-item" onclick="goToSection('habits')">
            <div class="mobile-icon-circle" style="background: linear-gradient(135deg, #EEF2FF, #FDF0FF);">üå±</div>
            <div class="mobile-icon-label">Habits</div>
        </div>
        <div class="mobile-icon-item" onclick="openProfilePicker()">
            <div class="mobile-icon-circle" style="background: linear-gradient(135deg, #F0F8FF, #E8F4FF);">üë§</div>
            <div class="mobile-icon-label">Profile</div>
        </div>
        <div class="mobile-icon-item" onclick="alert('Photos coming soon!')">
            <div class="mobile-icon-circle mobile-icon-photos">
                üñºÔ∏è
            </div>
            <div class="mobile-icon-label">Photos</div>
        </div>
        
        <div class="mobile-icon-item" onclick="openProfileSettings()">
            <div class="mobile-icon-circle mobile-icon-profiles">
                üë•
            </div>
            <div class="mobile-icon-label">Profiles</div>
        </div>
        
        <div class="mobile-icon-item" onclick="alert('Sidekick coming soon!')">
            <div class="mobile-icon-circle mobile-icon-sidekick">
                ‚ú®
                <div class="mobile-icon-badge">+</div>
            </div>
            <div class="mobile-icon-label">Sidekick</div>
        </div>
        
    </div>
    
    <!-- Today's Events Card -->
    <div class="mobile-today-card" id="mobileTodayCard">
        <div class="mobile-today-date" id="mobileTodayDate">
            Thursday, February 5
        </div>
        
        <!-- Today's events will be populated here -->
        <div id="mobileTodayEvents">
            <!-- Example event (will be populated by JS) -->
            <!-- Shown when there are events -->
        </div>
        
        <!-- No events message -->
        <div id="mobileNoEvents" style="color: #666; font-size: 16px;">
            No upcoming events today üòå
        </div>
    </div>
    
</div>

<!-- Mobile Navigation JavaScript -->
<script>
// Mobile navigation state
let currentMobileSection = 'home';

// Initialize mobile view on load
function initMobile() {
    if (window.innerWidth <= 768) {
        // Initialize hash routing
        handleHashChange();
        updateMobileTodayCard();
    }
}

// Show mobile home page
function showMobileHome() {
    if (window.innerWidth > 768) return;
    
    document.body.classList.remove('viewing-section');
    document.body.classList.remove('calendar-view');
    currentMobileSection = 'home';
    
    // Show home
    const homeEl = document.getElementById('mobileHome');
    if (homeEl) homeEl.style.display = 'block';
    
    // Hide all content sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Update header
    document.getElementById('mobileHeaderTitle').textContent = 'strongcalendar23';
    document.getElementById('mobileBackBtn').style.display = 'none';
    document.getElementById('mobileHomeIndicator').style.display = 'block';
    
    updateMobileTodayCard();
}

// Navigate to a section
function goToSection(sectionName) {
    if (window.innerWidth > 768) {
        // Desktop: use hash navigation
        window.location.hash = '#/' + sectionName;
        return;
    }
    
    // Mobile: update hash to trigger navigation
    window.location.hash = '#/' + sectionName;
}

// Handle hash change for routing
function handleHashChange() {
    const hash = window.location.hash;
    
    if (window.innerWidth > 768) {
        // Desktop: use hash for navigation
        if (hash && hash.startsWith('#/')) {
            const section = hash.substring(2);
            if (typeof switchSection === 'function') {
                switchSection(section);
            }
        } else if (!hash || hash === '#/' || hash === '#/home') {
            // Default to calendar
            if (typeof switchSection === 'function') {
                switchSection('calendar');
            }
        }
        return;
    }
    
    // Mobile: show section or home
    if (!hash || hash === '#/' || hash === '#/home') {
        showMobileHome();
    } else if (hash.startsWith('#/')) {
        const sectionName = hash.substring(2);
        
        // Mobile: show section with back button
        document.body.classList.add('viewing-section');
        
        // Add calendar-view class if viewing calendar
        if (sectionName === 'calendar') {
            document.body.classList.add('calendar-view');
        } else {
            document.body.classList.remove('calendar-view');
        }
        
        currentMobileSection = sectionName;
        
        // Hide home
        const homeEl = document.getElementById('mobileHome');
        if (homeEl) homeEl.style.display = 'none';
        
        // Show back button
        document.getElementById('mobileBackBtn').style.display = 'block';
        document.getElementById('mobileHomeIndicator').style.display = 'none';
        
        // Update header title
        const titles = {
            'calendar': getWeekRangeTitle(),
            'chores': 'Thu, Feb 5',
            'rewards': 'Rewards',
            'lists': 'Lists',
            'meals': 'Meals',
            'recipes': 'Recipes',
            'habits': 'Habits'
        };
        document.getElementById('mobileHeaderTitle').textContent = titles[sectionName] || sectionName;
        
        // Use existing switchSection function
        if (typeof switchSection === 'function') {
            switchSection(sectionName);
        }
    }
}

// Go back to mobile home
function goToMobileHome() {
    window.location.hash = '#/home';
}

// Listen for hash changes
window.addEventListener('hashchange', handleHashChange);

// Helper function to get week range title
function getWeekRangeTitle() {
    const today = new Date();
    const weekStart = new Date(today);
    const day = weekStart.getDay();
    const diff = weekStart.getDate() - day; // Sunday is 0
    weekStart.setDate(diff);
    
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    const options = { month: 'short', day: 'numeric' };
    const startStr = weekStart.toLocaleDateString('en-US', options);
    const endStr = weekEnd.toLocaleDateString('en-US', options);
    
    return `${startStr} - ${endStr}`;
}

// Update today's card with events
function updateMobileTodayCard() {
    const today = new Date();
    const options = { weekday: 'long', month: 'long', day: 'numeric' };
    const dateStr = today.toLocaleDateString('en-US', options);
    
    const dateEl = document.getElementById('mobileTodayDate');
    if (dateEl) {
        dateEl.textContent = dateStr;
    }
    
    // Get today's events
    if (typeof getAllEvents === 'function') {
        const todayStr = today.toISOString().split('T')[0];
        const allEvents = getAllEvents();
        const todayEvents = allEvents.filter(event => {
            if (typeof isEventOnDate === 'function') {
                return isEventOnDate(event, todayStr);
            }
            return event.date === todayStr;
        });
        
        const eventsContainer = document.getElementById('mobileTodayEvents');
        const noEventsEl = document.getElementById('mobileNoEvents');
        
        if (todayEvents.length > 0) {
            // Show events
            if (noEventsEl) noEventsEl.style.display = 'none';
            if (eventsContainer) {
                eventsContainer.innerHTML = '';
                
                todayEvents.slice(0, 3).forEach((event, index) => {
                    const colorClass = index % 2 === 0 ? 'color-pink' : 'color-peach';
                    const memberInitial = event.member ? event.member.charAt(0).toUpperCase() : '?';
                    const timeStr = event.time || 'All day';
                    
                    const eventHtml = `
                        <div class="mobile-today-event ${colorClass}" onclick="goToSection('calendar')">
                            <div class="mobile-event-content">
                                <div class="mobile-event-title">${event.title}</div>
                                <div class="mobile-event-time">${timeStr}</div>
                            </div>
                            <div class="mobile-event-avatar">${memberInitial}</div>
                        </div>
                    `;
                    eventsContainer.innerHTML += eventHtml;
                });
            }
        } else {
            // Show no events message
            if (noEventsEl) noEventsEl.style.display = 'block';
            if (eventsContainer) eventsContainer.innerHTML = '';
        }
    }
}

// Handle window resize
window.addEventListener('resize', function() {
    if (window.innerWidth <= 768) {
        if (currentMobileSection === 'home') {
            showMobileHome();
        }
    }
});

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initMobile();
        // Initialize Google Calendar OAuth
        if (typeof initGoogleCalendar === 'function') {
            initGoogleCalendar();
        }
    });
} else {
    initMobile();
    // Initialize Google Calendar OAuth
    if (typeof initGoogleCalendar === 'function') {
        initGoogleCalendar();
    }
}



// Profile picker ‚Äî defined here so it's available immediately on page load
function openProfilePicker() {
    var members = (typeof familyMembers !== 'undefined' ? familyMembers : [])
        .filter(function(m) { return !m.isGoogleCalendar; });
    if (members.length === 0) return;

    var existing = document.getElementById('profilePickerMount');
    if (existing) { existing.remove(); return; }

    var buttonsHtml = members.map(function(m) {
        return '<button class="ppick-btn" onclick="document.getElementById(\'profilePickerMount\').remove();openProfileDashboard(\''+m.name+'\')" style="--pmc:'+m.color+'">'
            + '<span class="ppick-avatar">'+m.name.charAt(0).toUpperCase()+'</span>'
            + m.name + '</button>';
    }).join('');

    var html = '<div id="profilePickerMount" class="ppick-overlay" onclick="this.remove()">'
        + '<div class="ppick-modal" onclick="event.stopPropagation()">'
        + '<div class="ppick-title">Whose dashboard?</div>'
        + '<div class="ppick-list">'+buttonsHtml+'</div>'
        + '<button class="ppick-cancel" onclick="document.getElementById(\'profilePickerMount\').remove()">Cancel</button>'
        + '</div></div>';

    var el = document.createElement('div');
    el.innerHTML = html;
    document.body.appendChild(el.firstChild);
}


// Profile settings placeholder
function openProfileSettings() {
    if (window.innerWidth <= 768) {
        alert('Profile settings coming soon!');
    }
}
</script>
</body>
</html>